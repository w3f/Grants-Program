# W3F Grant Proposal

> This document will be part of the terms and conditions of your agreement and therefore needs to contain all the required information about the project. Don't remove any of the mandatory parts presented in bold letters or as headlines! Lines starting with a `>` (such as this one) can be removed.
>
> See the [Grants Program Process](https://github.com/w3f/Grants-Program/#pencil-process) on how to submit a proposal.

* **Project Name:** Apsis
* **Team Name:** NUTS Finance
* **Payment Address:** 0x679824d755B054a2a50358008472a6F400740319(DAI)
* **[Level](https://github.com/w3f/Grants-Program/tree/master#level_slider-levels):** 3

> ⚠️ *The combination of your GitHub account submitting the application and the payment address above will be your unique identifier during the program. Please keep them safe.*

## Project Overview :page_facing_up:

We propose Apsis, a Polkadot parachain that supports synchronous and reliable invocation to HTTPS APIs with retroactive verifiability. 

Apsis can be used to build on-chain Oracles which provides end-to-end data verifiability from data sources to data consumers. It is being pitched as the Oracle chain in the Polkadot ecosystem and other blockchains via cross-chain bridge integration.

Apsis can be also used to build hybrid blockchain applications to take advantage of both Web 2.0 and Web 3.0. For more background about Apsis, please see [Apsis Light Paper](https://github.com/nutsfinance/research/blob/main/Apsis%20HTTPS-Empowered%20Blockchain.pdf).

### Overview

Satoshi Nakamoto’s Bitcoin introduces the concept of blockchain and signals the emergence of crypto currency. It is effectively the first blockchain application in the world. Ethereum expands the application scope of blockchain, extending from distributed payment network to generic computation platform for decentralized contracts and applications. Decentralized finance, mostly notably known as DeFi, is the dominant decentralized application on blockchain. Since Compound launched liquidity mining in August 2020, we have witnessed a more than 10 times growth in DeFi total locked value within 6 months.

The prosperity of DeFi exposes several shortcomings of existing blockchains, including low throughput and isolation from the external world. While the former can be addressed by new technologies such as sharding and rollup, the latter has no clean solution yet since existing blockchains are inherently isolated decentralized networks. Currently DeFi applications heavily rely on the so-called off-chain Oracles, which is backed by one or more off-chain operators, to help retrieve the external data and feed it back on-chain. Since the performance of the off-chain operators cannot be effectively validated on-chain, off-chain Oracles become the security bottleneck of DeFi applications.

Apsis empowers blockchain applications with HTTPS access capabilities. By introducing retroactive verifiability to HTTPS invocations, Apsis allows smart contract developers to implement on-chain Oracles which can invoke HTTPS API synchronously and reliably in blockchain transactions. Apsis also introduces hybrid blockchain applications which can further expand the application scope of blockchains and take full advantage of both Web 2.0 and Web 3.0.

### Project Details

Apsis is a Polkadot parachain which can interact with HTTP APIs. Apsis EVM allows developers to write Solidity smart contracts which can invoke HTTP APIs synchronously within a single transaction.

## Architecture

Apsis node consists of the following three main components:

* Off-chain EVM: EVM running on off-chain workers which supports synchronous HTTPS invocations and generates proof for each HTTPS session;
* On-chain EVM: EVM running on-chain which executes transactions with HTTPS session proofs generated by off-chain EVM;
* EVM Dispatcher: EVM Dispatcher receives transactions from DApp and performs transaction dispatch.
  * If a transaction does not involve HTTPS access, it can be executed on On-chain EVM directly;
  * Otherwise, it’s dispatched to Off-chain EVM to execute and generate HTTPS session proof. The proof, along with the transaction will be dispatched back to On-chain EVM to execute on-chain.

The two EVMs architectural design is adopted because Apsis requires raw SSL binary data to generate proof, as specified in later sessions. Therefore, the off-chain EVM is responsible for invoking HTTPS APIs, while on-chain EVM is responsible for validating the HTTPS session data and executing the transaction on-chain.

![Apsis Architecture](https://github.com/nutsfinance/research/blob/main/images/apasis_architecture.png?raw=true)

## Retroactively Verifiable HTTP Invocations

Blockchain transaction data needs to be retroactively verifiable. The validity of past transactions can be verified by any others, even when these transactions are mined on-chain a long time before. HTTP, on the other hand, does not provide such native retroactive verifiability. We cannot verify an HTTP response by simply re-invoking the HTTP API because the HTTP API data might change already, This is especially true for HTTP responses recorded long ago.

HTTP invocation can be retroactively verified as long as the following assumptions are met:

* HTTP server is using HTTPS with TLS 1.3;
* HTTP server has a valid SSL certificate;
* HTTP server returns a valid Date header.

Even though TLS 1.2 can offer similar verifiability, we are dedicated to TLS 1.3 due to its forward security, efficiency and simplicity. Below is a comparison between the TLS 1.2 and TLS 1.3 handshake process.

![TLS 1.2 vs TLS 1.3](https://github.com/nutsfinance/research/blob/main/images/tls_versions.png?raw=true)

If all three assumptions are met, we are able to construct a proof for an HTTP API invocation with the following elements:

* HTTPS server certificate
* Diffie-Hellman parameters
* HTTPS server signatures on Diffie-Hellman parameters
* Encrypted HTTP request and response

HTTPS server certificate certifies the HTTPS server public key. Combined with Diffie-Hellman parameters and the server signatures used in the HTTPS session, we are able to generate and verify the share key used in this session, which is in turn used to verify the HTTP request and response content. 

In other words, the first two assumptions, i.e. HTTPS with valid certificates, allow us to generate a proof that the data is read from a target server honestly. This makes the HTTP API invocation verifiable. The third assumption, i.e. a valid Date header in the HTTP response, makes this verification retroactive with a persistent proof for the HTTP response timing. All these combined generate a proof of whether and when an HTTP API is invoked so that it can work with other on-chain transaction data. 

One might argue that not all Web 2.0 HTTP servers can meet these three assumptions. We will discuss how we handle SSL certificates in section 3.2. For assumption 1 and 3, fortunately, almost all HTTP servers nowadays work with HTTPS and they are able to return a standard valid Date header. For those incompatible servers, they will be precluded implicitly by the blockchain applications. Since blockchain applications require gas to deploy smart contracts and execute transactions on-chain, they work for high-stake applications with high security and reliability demand. Therefore, it’s highly unusual if they select an API that does not support HTTPS or does not follow the HTTP standard.

In short , Apsis chain is not supposed to support all Web 2.0 servers, but instead works with HTTP servers that are needed by blockchain applications. 

## Apsis EVM

Apsis is an HTTPS-empowered blockchain which supports retroactively verifiable HTTPS invocations. The application scope of Apsis can be maximized with Apsis EVM, an HTTPS-empowered smart contract platform which allows smart contracts to invoke HTTPS API synchronously and reliably.

The HTTPS access capability in Apsis EVM is provided with an EVM precompile. Below is a sample of the HTTP precompile written in Solidity.

```
contract HTTPClient {
  // Format of the HTTP response content.
  enum Format{ JSON, TEXT, BINARY };

  // Reads data from an HTTP endpoint.
  // @param url URL to invoke
  // @param format Format of the HTTP response content
  // @param path Path of the data to return 
  // @param expiration Deadline of the HTTP invocation
  // @return The data specified as JSON path
  function getData(string url, Format format, string path, uint256 expiration) public returns (bytes memory);
}
```

The following code snippet shows how to invoke HTTPS API inside a solidity method.

```
function rebase() external {
  const _httpClient = HTTPClient.at(‘0x0000000000008’);
  const _data = httpClient.getData(‘https://api.token.com/prices/AMPL’, HTTPClient.Format.JSON, ‘price.value’, 10 minutes);

  uint256 _price = abi.decode(_data, {uint256});
  _rebaseWithPrice(_price);
}
```

This code snippet tries to read the latest price of AMPL token to determine whether a rebase operation is needed. Assume that the (faked) URL https://api.token.com/prices/AMPL
returns a JSON which contains AMPL’s latest price under path ‘price.value’. When the getData method is invoked on the HTTPClient precompile, it invokes https://api.token.com/prices/AMPL, reads and parses the JSON response, and returns the bytes data as result. Miners will append proof of the HTTPS invocation, as specified in section 3.1, as part of the transaction log.

Apsis EVM provides a much enhanced development experience than off-chain Oracles.

* Compared to pull-based Oracles, Apsis smart contract can invoke HTTPS API synchronously as part of the transaction. Smart contract logic is thus significantly more concise;
* Compared to push-based Oracles, Apsis smart contract supports ad-hoc HTTPS API URL which is infeasible with push-based Oracles;
* Apsis smart contract can access fresher data then both pull-based and push-based Oracles since data is read in the same transaction.

One potential problem is the storage size. As transactions involving HTTP invocation accumulate, HTTPS session proof is likely to bloat and consume large amounts of storage space. This problem can be addressed by offloading HTTPS session proofs to external decentralized storage. For example, for relatively old blocks, we could package HTTPS session proofs for every 100 blocks and store them in other decentralized, content-addressable storage solutions such as IPFS, while leaving the response data(e.g. the return value of getData() in the example above) stored on-chain. Therefore, if miners want to validate relatively old transactions, they can download the HTTPS session data and discard them afterwards.

## SSL Certificate Integration

As mentioned in the previous section, the second assumption to meet is that HTTPS server should have a valid SSL certificate. To verify an HTTPS invocation record, Apsis miners need to validate its SSL certificate at the same time of the HTTPS invocation, since this SSL certificate might become invalid at the time of validation.

To help achieve global consensus on SSL certificate validity, Apsis integrates SSL certificate validation as part of the blockchain implementation. Apsis maintains both the root CA certificates and the Certificate Revocation Lists(CRL) on-chain. Whenever new certificates are revoked, Apsis DAO submits a change to CRL so that the newly revoked certificates, along with the revocation date, are updated on-chain.

The process to validate an SSL certificate at a specific timestamp is as follows:

1. Check whether the certificate has valid proof from CA. If no, the certificate is invalid;
2. Check whether the certificate expires before the target timestamp. If yes, the certificate is invalid;
3. Check whether the certificate is on the CRL. If so, check whether its revocation timestamp is before the target timestamp. If yes, the certificate is invalid;
Otherwise, the certificate is valid at the target timestamp.

Since anyone can validate an SSL certificate for any given timestamp,  Apsis chain can be seen as a public welfare chain on its own, since it could solve the availability and usability issues of the current Online Certificate Status Protocol(OCSP).


### Ecosystem Fit

Polkadot is the best place to develop Apsis as it provides shared security and native cross-chain capabilities. Apsis can focus on HTTPS-Empowered smart contract development, and it could serve applications across multiple parachains via XCMP.

## Polkadot Oracle Chain

One notable application of Apsis is On-chain Oracles which provides end-to-end verifiability to access external data.

![On-Chain vs Off-Chain Oracles](https://github.com/nutsfinance/research/blob/main/images/On-chain%20vs%20Off-chain%20Oracles.png?raw=true)

There are two critical differences between off-chain Oracles and on-chain Oracles:

* Oracle nodes are no longer required in on-chain Oracles since on-chain Oracles can access HTTP API directly. This might imply significant operational cost since no middleman tax is paid to Oracle nodes;
* Data from HTTP API to Oracle contract is completely verifiable in on-chain Oracles. This means the data consumers only need to trust the HTTP API providers, in contrast to off-chain Oracles where data consumers need to trust the Oracle nodes to operate honestly.

The presence of on-chain Oracle does not preclude the existence of third-party Oracle providers. Existing Oracle providers can build their Oracle solutions on Apsis which read data from multiple HTTP APIs and aggregate data points. There are several benefits to build on-chain Oracle solutions on Apsis:

* On-chain Oracles on Apsis provide end-to-end data verifiability. Oracle data consumers don’t have to trust the Oracle providers as the whole data generation process is visible on-chain;
* Oracle providers don’t have to manage their Oracle node networks and overpay them with their own tokens. Instead, Oracle providers can better utilize their token to bootstrap the ecosystem;
* On-chain Oracles can support both realtime and cached data access. Oracle data consumers can pay more to trigger a new round of data update in order to read the latest data, or pay a small portion to access the data cached in the last round update.

The Apsis chain can become the Oracle chain in the Polkadot ecosystem. Other Polkadot parachains can build their on-chain Oracles on Apsis and access Oracles via Cross-Chain Message Processing(XCMP) protocol. External blockchains such as Ethereum and BSC can also access Apsis on-chain Oracles using parachain bridges.

![Oracle Chain](https://github.com/nutsfinance/research/blob/main/images/oracle_chain.png?raw=true)

## Hybrid Blockchain Applications

The true potential of the Apsis chain is definitely not limited to Oracle. Since smart contracts on Apsis can access HTTP API synchronously within a single transaction, developers are able to write smart contracts involving complicated HTTP interactions, which are currently not available in any existing blockchain.

In other words, Apsis opens the space for totally new kinds of applications, which we call hybrid blockchain applications, to take full advantage of both the security and reliability from Web 3.0, and diversity and complexity from Web 2.0.

Assume that an electronics retailer wants to build a blockchain application to sell their televisions. Since there are many TVs available and their inventory information changes frequently, the retailer does not want to maintain all information on-chain. Instead, they rely on their in-house inventory system to provide price and inventory information. Users can purchase TV with cryptocurrency via the sales blockchain application and anyone can verify the sale transaction information on-chain.

![Hybrid Blockchain Applications](https://github.com/nutsfinance/research/blob/main/images/Hybrid%20Blockchain%20Application.png?raw=true)

It is difficult to implement the sales DApp using existing Oracle solutions. Push-based Oracle doesn't work since it will be expensive to push all prices and inventory information on the chain. Pull-based Oracle also has its own issues.

* First, the purchase experience will have to break into multiple transactions since the pull-based Oracle is asynchronous. The problem is worse as the purchase involves multiple HTTP interactions, especially when these HTTP interactions depend on each other. In such a case, the users might have to sign multiple transactions with long time waiting to complete their purchase;
* Second, both users and the retailer have to trust the Oracle to return the correct information from the inventory system. If something goes here, say, a TV is sold at $10, it would be difficult to figure out where the mistakes come from.

All these problems can be solved with Apsis. Since Apsis enables smart contract transactions with synchronous HTTPS invocations, the sale DApp can complete the purchase experience in a single transaction. In addition, if a TV is sold at $10, we could easily identify whether the $10 price comes from the inventory system since all HTTPS interactions are recorded and can be verified by any users. Moreover, by eliminating the Oracle nodes as the middleman, the development and operational cost can be substantially smaller.

## Team :busts_in_silhouette:

### Team members

* Daniel Tang, founder
* Terry Lam, founder
* Shengda Ding, founder

### Contact

* **Contact Name:** Shengda Ding
* **Contact Email:** shengda@nuts.finance
* **Website:** [https:/nuts.finance](https:/nuts.finance)

### Legal Structure

* **Registered Address:** PO Box 309, Ugland House, Grand Cayman, KY1-1104, Cayman Islands
* **Registered Legal Entity:** ACoconut

### Team's experience

Organized in 2018, NUTS Finance is a blockchain development DAO which focuses on building secure, composable and open source technology to enable financial applications on the blockchain.

Our core team is composed of engineers, financiers, security experts and serial entrepreneurs. Our approach is open, global and blockchain agnostic.

Through multiple projects, our aim is to deliver the working elements that can help shape the emerging crypto economy.

### Team Code Repos

* [https://github.com/nutsfinance](https://github.com/nutsfinance)

### Team LinkedIn Profiles (if available)

[https://www.linkedin.com/in/joeztang](https://www.linkedin.com/in/joeztang)
[https://www.linkedin.com/in/terry-lam-80a71927](https://www.linkedin.com/in/terry-lam-80a71927)
[https://www.linkedin.com/in/dingshengda/](https://www.linkedin.com/in/dingshengda/)

## Development Status :open_book:

If you've already started implementing your project or it is part of a larger repository, please provide a link and a description of the code here. In any case, please provide some documentation on the research and other work you have conducted before applying. This could be:

* links to improvement proposals or [RFPs](https://github.com/w3f/Grants-Program/tree/master/rfp-proposal) (requests for proposal),
* academic publications relevant to the problem,
* links to your research diary, blog posts, articles, forum discussions or open GitHub issues,
* references to conversations you might have had related to this project with anyone from the Web3 Foundation,
* previous interface iterations, such as mock-ups and wireframes.

## Development Roadmap :nut_and_bolt:

### Overview

* **Total Estimated Duration:** 6 months
* **Full-Time Equivalent (FTE):**  4
* **Total Costs:** 120,000 DAI

### Milestone 1 Example — Implement SSL Certificate Modules

* **Estimated duration:** 1 month
* **FTE:**  4
* **Costs:** 20,000 DAI

| Number | Deliverable | Specification |
| -----: | ----------- | ------------- |
| 0a. | License | Apache 2.0 |
| 0b. | Documentation | We will provide the following documentations:<ul><li>Inline Code Documentation</li><li>Configuration Documentation</li><li>docket Setup Documentation</li><li>SSL Certificate Validation Module Deployment Documentation</li></ul> |
| 0c. | Testing Guide | Core functions will be fully covered by unit tests to ensure functionality and robustness. In the guide, we will describe how to run these tests. |
| 0d. | Docker | We will provide a Dockerfile(s) that can be used to test all the functionality delivered with this milestone. |
| 0e. | Article | We will publish an article that explains how Apsis can solve the problems of existing SSL certificate infrastructure. We will host a workshop that incentivizes developers to integrate Apsis with existing SSL infrastructures and applications. |
| 1. | Substrate module: SSL Certificate Module | This Substrate module provide two core functionalities: <br/><ul><li>Allows public users to check the validity of an SSL certificate at any given timestamp;</li><li>Allows Apsis DAO members to propose and vote updates on Certificate Revocation List.</li></ul> |  
| 2. | Substrate chain | We will deploy the initial version of Apsis chain with SSL Certificate Module to Rococo. Apsis testnet should operate independently as a public warfare chain as a standalone SSL certificate infrastructure. |  


### Milestone 2 Example — Implements HTTPS Client Modules

* **Estimated Duration:** 2 month
* **FTE:**  4
* **Costs:** 40,000 DAI

| Number | Deliverable | Specification |
| -----: | ----------- | ------------- |
| 0a. | License | Apache 2.0 |
| 0b. | Documentation | We will provide the following documentations:<ul><li>Inline Code Documentation</li><li>Configuration Documentation</li><li>docket Setup Documentation</li><li>HTTPS Client Module Deployment Documentation</li></ul> |
| 0c. | Testing Guide | Core functions will be fully covered by unit tests to ensure functionality and robustness. In the guide, we will describe how to run these tests. |
| 0d. | Docker | We will provide a Dockerfile(s) that can be used to test all the functionality delivered with this milestone. |
| 0e. | Article | We will publish an article to explain how retroactively verifiable HTTP invocation works, as well as its benefits and potential applications. |
| 1a. | Substrate Off-Chain Worker: HTTPS Invoker | HTTPS Invoker is a Substrate off-chain worker that invokes HTTPS APIs and generates HTTPS session proof. It relies on the runtime interface provided by Apsis runtime to access HTTPS server. |
| 1b. | Substrate Module: HTTPS Validator | HTTPS Validator is a Substrate modules that validates HTTPS session proof generated by HTTPS invoker and persists HTTPS session data on-chain. |
| 2. | Substrate chain | We will deploy the HTTPS Client module on Apsis testnet. We will also integrate HTTPS Client with XCMP to provide other parachains with HTTPS accessibility. |  

### Milestone 3 Example — Implements Apsis EVM

* **Estimated Duration:** 3 month
* **FTE:**  4
* **Costs:** 60,000 DAI

| Number | Deliverable | Specification |
| -----: | ----------- | ------------- |
| 0a. | License | Apache 2.0 |
| 0b. | Documentation | We will provide the following documentations:<ul><li>Inline Code Documentation</li><li>Configuration Documentation</li><li>docket Setup Documentation</li><li>Apsis EVM Deployment Documentation</li></ul> |
| 0c. | Testing Guide | Core functions will be fully covered by unit tests to ensure functionality and robustness. In the guide, we will describe how to run these tests. |
| 0d. | Docker | We will provide a Dockerfile(s) that can be used to test all the functionality delivered with this milestone. |
| 0e. | Article | We will host a workshop to build applications with Apsis EVM. |
| 1a. | Substrate Off-chain Worker: Off-chain EVM | Off-chain EVM is a Substrate off-chain worker that executes EVM transactions involving HTTPS access. It relies on HTTPS Invoker to provide HTTPS access functionalities.<br>When HTTPS client precompile is invoked, Off-chain EVM synchronously invokes HTTPS APIs specified, generates proof and returns the parsed result. |
| 1b. | Substrate Module: On-chain EVM | On-chain EVM is a Substrate module that executes EVM transactions on chain. <br>When HTTPS client precompile is invoked, On-chain EVM validates the HTTPS session proof generated by Off-chain EVM and executes the transaction. |
| 1c. | Substrate Module: EVM Dispatcher | EVM Dispatcher is the front interface for EVM transactions. When new transaction is received, EVM dispatcher does the following: <ul><li>If the transaction does not involve HTTPS access, it’s executed on On-chain EVM directly;</li><li>Otherwise, it is dispatched to Off-chain EVM to execute and generate HTTPS proof. The generated HTTPS proof, along with the EVM transaction are dispatched to On-chain EVM to execute on-chain.</li></ul> |
| 2. | Substrate chain | We will deploy the Apsis EVM module on Apsis testnet. |  


## Future Plans

We plan to build on-chain Oracles for asset prices on Apsis, and integrate them with cross-chain applications, e.g. DeFi applications on Acala.

We also plan to incorporate HTTPS capabilities to Ink smart contract platform to allow Ink developer to write HTTPS-empowered Ink smart contracts.


## Additional Information :heavy_plus_sign:

We’ve successfully launched two DeFi products on Ethereum, acBTC and BTC+. We’ve completed a W3F Open Grant for stable asset, which uses Curve’s StableSwap algorithm to generate synthetic assets from a basket of assets with the same peg.
 
Based on our past experience in DeFi and Polkadot, we believe Oracle is one of the most critical bottlenecks of DeFi, and we believe Polkadot offers the best infrastructure to build such an Oracle chain.

